

# 精准投资-前端

## 一、数据库连接

>  uap-client--WebContent--datasource.xml中设置数据库

```xml
<property name="url" value="jdbc:oracle:thin:@192.168.1.210:1521/orcl"/>
<property name="username" value="redis_new_sx"/>
<property name="password" value="telek"/>
```

## 二、修改连接后端URL

> pis_lcc_webcore--src--framework中的Const.java中设置链接

```java
static {
    Map<String, String> paraMap = new HashMap<String, String>();
    paraMap.put("url", "JZTZ_URL");//后台连接地址
    paraMap.put("DGH_WEB_URL", "DGH_WEB_URL");//大规划前台连接地址
    initConfigMap(paraMap);
    initRestURL();
    initServiceMap();
    initSguds();
    // 设置链接
    configMap.put("JZTZ_URL", "http://192.168.1.19:5555/");
}
```

==修改链接之后 配置更新 无需重启==

控制台输入ss 查看所需更新项目id

updm id号 即可更新

## 三、My97DatePicker-年份控件使用

```html
<div id="" style="margin-left: 12px;">
    <label ACCESSKEY="1">年份</label>
    <input id="ten_year" value="" style="width:120px;height: 23px;float: none;border:1px solid #D0D0D0 !important;" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy',isShowToday:false,isShowClear:false});">
</div>
```

```js
//-----------------------页面元素初始化方法---------------------------------
var getJqControls = function(){
    $year = $('#ten_year');//年份
};
/**
 * 初始化年份控件
 */
var initYear = function(){
    var year = new Date().getFullYear();
    // 设置默认值为当前年份
    $year.val(year);
    // 设置只读，不可编辑
    $year.attr("readOnly",true);
};
```

## 四、表格

[方法汇总](https://www.cnblogs.com/liuqiyun/p/8618121.html)

### 4.1 获取表头数据

```js
// ajaxPath:ajax请求根路径   repId: 左侧树对应Id
var finaltitle = mCommon.getTitle(ajaxPath, repId);
// 表格左侧固定列表头
var leftcols= finaltitle.leftcols;
// 表格右侧数据表头
var rightcols= finaltitle.rightcols;
```

### 4.2 动态设置背景色

> 根据repId的不同，动态设置列的不同颜色

### 4.3 单击一个单元格触发

```js
onClickCell: function(rowIndex, field, value){
    // 若单位编码为15位 单击没反应
    if(userInfo.compCode.length == 15){
        return
    }
    // 单击时获取最后编辑的索引
    var lastIndex = global.lastIndex;
    if (lastIndex !== null) {
        // 结束编辑
        $(this).datagrid('endEdit',lastIndex);
    }
    // 返回当前页的记录
    var rows = $(this).datagrid('getRows');
    // 单击提示行没反应
    if(rows[rowIndex].id && rows[rowIndex].id == -1){//提示行
        return;
    }
    // 单击汇总行没反应
    if(rowIndex == 0){//合计行   / 汇总行
        return;
    }
    /*if(rows[rowIndex].compname && rows[rowIndex].compname == '合计'){//合计行
	    			return;
	    		}*/
    // 返回特定的列属性
    var editor = $(this).datagrid('getColumnOption',field).editor;
    if($.isEmptyObject(editor)){
        return;
    }
    // 记录单击的列索引
    global.lastIndex = rowIndex;
    // 记录列表头
    global.field = field;
    // 记录改变之前当前页数据
    global.lastData = clone(rows);
    $(this).datagrid('beginCellEditExt', {
        index : rowIndex,
        field : field,
        value : value,
        target : this
    });
    event.stopPropagation();
},
```

### 4.4 结束编辑

> 当用户编辑完成时触发，参数如下：
> rowIndex：正在编辑的行索引，从0开始。
> rowData：对应于正在编辑的行的记录。
> changes：被改变的字段内容，对应方式为字段：值。

```js
onAfterEdit:function(index,row,changes){
    // 判断是否发生改变
    if($.isEmptyObject(changes)) {
        return;
    }
    // 获取改变之前的数据
    var oldValue = global.lastData[index][global.field];
    // 获取改变之后的数据
    var newValue = changes[global.field];
    // 计算改变差值
    var changeValue = dealNull(newValue) - dealNull(oldValue);
	// 未改变 
    if(changeValue == 0){
        return;
    }
    //var rows = $(this).datagrid('getRows');

    if(userInfo.compCode.length == 12 && !citySummaryCheck(index,global.field,newValue,oldValue)){//市公司校验
        return
    }
    calInc(index,global.field,changeValue,oldValue);
},
```

### 4.5 设置行样式(汇总行颜色)

> 返回样式，如：'background:red'，function有2个参数：
> index：行索引，从0开始.
> row：对应于该行记录的对象。

```js
rowStyler: function(index, row) {
    style = "";
    // 若行存在且有bgcolor属性 则赋予行颜色（用于合计行）
    if (row && row.bgcolor) {
        style += 'background-color:'+row.bgcolor+' !important;';
    }
    if (row && row.bold == '1') {
        style += 'font-weight:bold !important;';
    }
    return style;
}
```

### 4.6 计算汇总值（横向合计 纵向合计）

```js
var calInc = function(index,field,changeValue,oldValue){
    // 获取当前页数据
    var rows = $itemGrid.datagrid('getRows');
    // 匹配修改字段
    switch(field){
        case 'cw_inv'://城网规模
            var currentKey = 'cw_inv';//当前编辑列   本批计划
            var downKey = 'cw_scale';//城网/农网  累计下达
            var totalKey = 'total_scale';//累计下达
            break;
        case 'cw_inv_yk'://城网业扩配套
            var currentKey = 'cw_inv_yk';
            var downKey = 'cw_scale_yk';
            var totalKey = 'total_scale_yk';
            break;
        case 'nw_inv'://农网规模
            var currentKey = 'nw_inv';
            var downKey = 'nw_scale';
            var totalKey = 'total_scale';
            break;
        case 'nw_inv_yk'://农网业扩配套
            var currentKey = 'nw_inv_yk';
            var downKey = 'nw_scale_yk';	
            var totalKey = 'total_scale_yk';
            break;
        default:
            return;
    }
	// 累计下达值+改变值 <0 累计下达值为负，
    if(dealNull(rows[index][downKey]) + dealNull(changeValue) < 0){
        swalWarningInfo('累计下达值为负，请重新编辑！');
        // 改变单元格数据自动改回塬数据
        rows[index][currentKey] = oldValue;
        // 刷新当前行
        $itemGrid.datagrid('refreshRow', index);
        return false;
    }
    // 单位编码为12的
    if(userInfo.compCode.length == 12){
        // 修改单元格数据不能大于合计行本批计划
        if(dealNull(rows[index][currentKey]) > dealNull(rows[0][currentKey])){
            swalWarningInfo('超市公司值，请重新编辑!')
            rows[index][currentKey] = oldValue;
            $itemGrid.datagrid('refreshRow', index);
            return false;
        }
    }
    // 标识编辑状态为true
    global.editFlag = true;
    // 城网/农网 累计下达值=累计下达值+改变值
    rows[index][downKey] = dealNull(rows[index][downKey]) + dealNull(changeValue);
    // 省公司累计下达值=累计下达值+改变值
    rows[index][totalKey] = dealNull(rows[index][totalKey]) + dealNull(changeValue);
    // 刷新修改行
    $itemGrid.datagrid('refreshRow', index);
    //单位编码为9 
    if(userInfo.compCode.length == 9){
        // 合计行本批计划值 = 合计行本批计划值 + 改变值
        rows[0][currentKey] = dealNull(rows[0][currentKey]) + dealNull(changeValue);
        // 合计行城网/农网 累计下达值=合计行累计下达值 + 改变值
        rows[0][downKey] = dealNull(rows[0][downKey]) + dealNull(changeValue);
        // 合计行省公司累计下达值 = 合计行省公司累计下达值 + 改变值
        rows[0][totalKey] = dealNull(rows[0][totalKey]) + dealNull(changeValue);
        // 刷新合计行
        $itemGrid.datagrid('refreshRow', 0);
    }
    return true;
}
```

### 4.7 动态改变列颜色

> 1.  匹配左侧树选项
>
> 2.  rightcols为后端传来的表头数据
>
> 3.  rightcols [1] [2].styler = editStylerFunc; 设置表头对应列颜色 即**本批计划**列改变颜色
>
>    ![image-20200714171320948](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20200714171320948.png)

```js
var editStylerFunc = function(value,row,index){
    // 对应行没有bgcolor属性（也就是合计行）
    if( !row.bgcolor){
        return 'background-color:rgba(222,237,255,1)';
    }
}
```

### 4.8 获取从最后一次提交开始的被修改的所有行

> 获取从最后一次提交开始的被修改的所有行，type参数表明修改的类型，可选值：inserted，deleted，updated等 。当没有传递type参数时，返回所有被修改的行。

```js
var rows = $itemGrid.datagrid('getChanges');
```

### 4.9 获取选中行的数据

```js
var rows = $itemGrid.datagrid('getChecked');
var rowaSelections = $reportGrid.datagrid('getSelections');
```

### 4.10 为表格赋值

```js
//表格id  compJson需要的为json数据
$("#compCapitalGrid").datagrid('loadData',compJson);
```

### 4.11 动态表头

> 根据选择的多选年份，表头动态改变

```js
//获取年份控件数据
var yearArr = $planyear.combobox('getValues');
// 给多选年份排序
yearArr = yearArr.sort(function(a,b){
    return a - b;
});
var yearLen = yearArr.length;
var yearList=[];
var titlewidth = yearLen == 1 ? 120 : 100;
// 设置年度投资计划占 年份个数+1列
finaltitle.rightcols[0][11].colspan = yearLen+1;
for(var i = 0; i < yearArr.length; i++){
    yearList.push({
        align: "center",
        colspan: 1,
        field: "rail"+yearArr[i],
        frozen: "0",
        halign: "center",
        rowspan: 1,
        title: yearArr[i],
        width: titlewidth
    });
}
// 若年份只有一个年，则只显示一年，隐藏小计列
if(yearLen ==1){
    insert(rightcols[1],yearList,0);
    rightcols[1].splice(1,1);
}else if(yearLen == 0){//若年份都取消了，点击查询，显示当前年数据
    var year = new Date().getFullYear();
    yearList.push({
        align: "center",
        colspan: 1,
        field: "rail"+year,
        frozen: "0",
        halign: "center",
        rowspan: 1,
        title: year,
        width: 120
    });
    insert(rightcols[1],yearList,0);
    rightcols[1].splice(1,1);
}else{
    insert(rightcols[1],yearList,1);
}
```

```js
/**
	 * 数组中间插入函数 arrlast数组插入到arrfirst，index:插入的位置索引
	 */
function insert(arrfirst,arrlast,index){
    if (index < 0){
        index = 0;
    }else if(index > arrfirst.length){
        index = arrfirst.length;
    }
    for (var i = arrlast.length-1; i >= 0; i--){
        arrfirst.splice(index,0,arrlast[i]);//是在index位置用arrlast[i]替换掉arrfirst数组中的0个元素
    }
    return arrfirst;
}
```

### 4.12 js为表格添加多选框

```js
//此处为无固定列情况，若有固定列用leftcols
rightcols[0].unshift({
    field:'ck',//起名随意
    checkbox:'true'
});
```

## 五、Layui表格分页插件

```html
<div style="width: 100%;background-color: #FFF;">
    <div id="paging" style="width: 100%;padding: 0 12px;"></div>
</div>
```

```js
// 1.定义全局变量 ---分页信息
var pageInfo = {
    currentpage : 1,
    pagenum : 20,
    total : 0
}
/**
  * 2.--分页加载
  */
var loadPaging = function(){
    layui.use('laypage', function(){
        var laypage = layui.laypage;
        // 执行一个laypage实例
        paging = laypage.render({
            elem: 'paging',// 注意，这里的 paging 是 ID，不用加 # 号
            count: pageInfo.total,
            curr: pageInfo.currentpage,
            limits: [20,50,100],
            limit: pageInfo.pagenum,// 每页默认显示的数量
            layout: ['count','limit','skip','first','prev','page','next','last'], // 自定义分页布局
            prev: '<i class="layui-icon">&#xe603;</i>',
            next: '<i class="layui-icon">&#xe602;</i>',
            theme: '#FF5722',
            jump: function(obj, first){
                // 首次不执行
                if(!first){
                    pageInfo.currentpage = obj.curr;
                    pageInfo.pagenum = obj.limit;
                    searchFunc('pageFlag');
                    // getData(true);
                    // loadData(obj.curr,obj.limit);
                }
            }
        });
    });
}
```

```css
/*设置CSS改变分页组件全部居左样式 变为部分居左 部分居右*/
.layui-laypage{
	text-align: right;
	display: inherit;
}
.layui-laypage-count{
	float: left;
}
.layui-laypage-limits{
	float: left;
}
.layui-laypage .layui-laypage-curr .layui-laypage-em{
	background-color: #359691 !important;
}
```

## 六、下拉框-赋值

### 6.1 获取前后5年年份赋予

```html
<input id="planyear" value="" style="width: 120px;">
```

```js
/**
 * 初始化年份控件
 */
$planyear.combobox({	
    data : global.plantimedata,
    valueField: 'id',
    textField: 'text',
    editable : false,
    multiple:true,
    panelWidth : 120,
    panelHeight: 200
});
// 赋初值
var year = new Date().getFullYear();
$planyear.combobox({	
    data : global.plantimedata,
    valueField: 'id',
    textField: 'text',
    editable : false,
    multiple:true,
    panelWidth : 120,
    panelHeight: 200
}).combobox('setValue',year);
```

```js
var global = {
    plantimedata:getYearListData(5,5)
};
```

```js

/**
 * 获取年份列表数据
 * @param pre
 * @param next
 * @return
 */
function getYearListData(pre, next) {
	var tempComboYearList = '';
	var currentYear = new Date().getFullYear();
	var fromYear = currentYear - parseInt(pre);
	var toYear = currentYear + parseInt(next);
	tempComboYearList += '[';
	var commaFlag = ',';
	for ( var i = toYear; i >= fromYear; i--) {
		if (i == fromYear) {
			commaFlag = '';
		}
		tempComboYearList += '{"id":"' + i + '","text":"' + i + '年"}' + commaFlag;
	}
	tempComboYearList += ']';
	return eval('(' + tempComboYearList + ')');
}
```

### 6.2 数据在js中，电压等级赋值

 ```js
//引入common.js后  common中定义了电压等级数据
<input id="updateuservollevel" class="telek-input">

var vollevelList = mCommon.VOL.query_1;
$("#updateuservollevel").combobox({
    data:vollevelList,
    valueField:'id',
    textField:'text',
    editable:false,
    panelWidth:152,
    panelHeight:200
});
 ```

### 6.4 自定义数据，项目类型赋值

```js
// 定义全局变量
var itemTypeList=[{id:'1',text:'公司出资'},{id:'2',text:'用户出资'}];
/**
 * 初始化项目类型下拉框控件
 */
var itemTypeData = itemTypeList;
$itemtype.combobox({
    data: itemTypeData,
    valueField: 'id',
    textField: 'text',
    editable: false,
    panelWidth: 120,
    panelHeight:'auto'
});
```



## 七、表格中加按钮

```js
// 滑动列加按钮，选好对应数组的那一列 添加formatter

//表格内挂接按钮
rightcols[0][3].formatter = mountFormatter;

// 当当前行的hookitem为1时显示为挂接按钮
var mountFormatter = function(value,row,index){
    if(row.hookitem == '1'){
        return '<button class="mountBtn">挂接</button>';
    }else{
        return '';
    }
}
```

## 八、Layui弹出层使用

### 1. 弹出层内容在html中写

```html
<button class="telekbtn" id="createBtn">创建</button>
<style>
    body .demo-class .layui-layer-title{
        background-color:#fff;
    }
</style>

<!--弹出层表单-->
<div id="create" style="display:none;height:100%">
    <div class="row createDiv" style="margin-top:0px;padding-top:20px;">
        <div class="col-md-3 col-md-offset-2">
            <label class="createLebel"><span style="color:red">* </span>铁路名称</label>
        </div>
        <div class="col-md-6">
            <input id="railwayname" class="telek-input">
        </div>
    </div>

    <div class="row createDiv">
        <div class="col-md-3 col-md-offset-2">
            <label class="createLebel"><span style="color:red">* </span>起始站</label>
        </div>
        <div class="col-md-6">
            <input id="startstation" class="telek-input">
        </div>
    </div>

    <div class="row createDiv">
        <div class="col-md-3 col-md-offset-2">
            <label class="createLebel"><span style="color:red">* </span>终点站</label>
        </div>
        <div class="col-md-6">
            <input id="endstation" class="telek-input">
        </div>
    </div>

    <div class="row createDiv">
        <div class="col-md-3 col-md-offset-2">
            <label class="createLebel"><span style="color:red">* </span>途径省公司</label>
        </div>
        <div class="col-md-6">
            <input id="wayprovince" class="telek-input">
        </div>
    </div>
    <div class="row createDiv">
        <div class="col-md-3 col-md-offset-2">
            <label class="createLebel">铁路投运日期</label>
        </div>
        <div class="col-md-6">
            <input id="usedate" class="telek-input" readonly="true" onClick="WdatePicker({dateFmt:'yyyy-MM'})">
        </div>
    </div>
    <div style="float:right;margin-top:20px;margin-right:20px">
        <button type="button" class="telekbtn" id="createSave">保存</button>
        <button type="button" class="telekbtn" id="cancelCreate" style="color:#333333;background-color:#E0E0E0">取消</button>
    </div>
</div>
```

```js
/**
 * 创建按钮触发
 */
$createBtn.bind('click',function(){
    createInterfaceFunc();
})
/**
 * 点击创建 弹出层界面
 */
var createInterfaceFunc = function(){
    layui.use('layer', function(){
        layerCreateInterface = layer.open({
            title: '铁路信息维护',
            type:1,
            skin: 'demo-class',//设置标题背景色为白色
            content: $("#create"),
            area: ['400px','305px']
        })
        layer.ready(function(){
            // 初始化清空数据
            $("#railwayname").val("");
            $("#startstation").val("");
            $("#endstation").val("");
            $("#wayprovince").val("");
            $("#usedate").val("");
			// 防止下拉组件因层级问题显示在遮罩后
            $(".layui-layer-shade").css('z-index',100);
            $(".layui-layer-page").css('z-index',101);
            /**
				 * 初始化起始站控件
				 */
            $startstation.combotree({			
                editable : false,
                data : userInfo.companyTree,
                value: userInfo.companyTree[0].id,
                panelWidth : 152,
                panelHeight: 200,
            });
            // 创建-保存
            $("#createSave").on('click',function(){
                addRailWayFun();
            });
            // 取消-关闭弹出层
            $("#cancelCreate").on('click',function(){
                layer.close(layerCreateInterface);
            })
        });  
    });
}
```

### 2. 弹出层内容直接在js中写

> 当前为点击表格中按钮触发的弹出层
>
> 开启对按钮的监听 需要在表格数据加载结束之后加入，即在对应表格的Search方法中对表格赋值成功后加入

```js
//数据加载完毕即可监听挂接按钮
$(".mountBtn").on('click',function(){
    mounting();
});

/**
 * 点击挂接 弹出层
 */
var mounting = function(value){
    layui.use('layer', function(){
        layerMountGlobal=layer.open({
            title: '挂接',
            type:1,
            skin: 'demo-class',//设置标题背景色为白色
            content: `<div style="margin-top:50px;text-align:center">
                        <button class="itemTypeBtn toComp">公司出资</button>
                        <br><br>
                        <button class="itemTypeBtn toUser">用户出资</button>
                      </div>`,
            area: ['500px','300px']
        });

        $(".toComp").on('click',function(){
            compCapital();
        });
        $(".toUser").on('click',function(){
            useCapital();
        });
    });
}
```

##  九、div高度不定，内容水平垂直居中

```html
<div class="left_display">
    <div class="left_content">
        <div>
            <p class="p_content">创建铁路条数</p>
            <p class="bigFont">32234</p>
            <p class="p_content">条</p>
        </div>
    </div>
    <div class="left_content">
        <div>
            <p class="p_content">电铁供电项目数量</p>
            <p class="bigFont">32234</p>
            <p class="p_content">项</p>
        </div>
    </div>
    <div class="left_content">
        <div>
            <p class="p_content">已关联项目数量</p>
            <p class="bigFont">32234</p>
            <p class="p_content">项</p>
        </div>
    </div>
    <div class="left_content" style="border-bottom:none;">
        <div>
            <p class="p_content">关联数量比例</p>
            <p class="bigFont">32.32%</p>
            <p class="p_content">项</p>
        </div>
    </div>
</div>
```

```js
.left_content{
	height:25%;
	text-align:center;
	border-bottom:1px solid #E0E0E0;
    
    display: flex;
    flex-direction: column;
    justify-content: space-around;
}
```

## 十、JS获取当前年月

```js
//2020-07
function doHandleDate() {
    var myDate = new Date();
    var tYear = myDate.getFullYear();
    var tMonth = myDate.getMonth();
 
    var m = tMonth + 1;
    if (m.toString().length == 1) {
        m = "0" + m;
    }
    return tYear +'-'+ m;
}
//2020
function doHandleYear(tYear) {
    var myDate = new Date();
    var tYear = myDate.getFullYear();
 
    return tYear;
}
//07
function doHandleMonth() {
    var myDate = new Date();
    var tMonth = myDate.getMonth();
 
    var m = tMonth + 1;
    if (m.toString().length == 1) {
        m = "0" + m;
    }
    return m;
}
```

## 十一、处理空数字

```js
/**
	 * 处理空数字
	 */
var dealNull = function(colValue){
    if(colValue=="" || colValue==undefined  || colValue==null ){
        return 0;
    }else if(isNaN(colValue)){
        return 0;
    }else{
        return colValue*1;
    }
}
```

## 十二、数组中间插入函数

```js
/**
	 * 数组中间插入函数 arrlast数组插入到arrfirst，index:插入的位置索引
	 */
function insert(arrfirst,arrlast,index){
    if (index < 0){
        index = 0;
    }else if(index > arrfirst.length){
        index = arrfirst.length;
    }
    for (var i = arrlast.length-1; i >= 0; i--){
        arrfirst.splice(index,0,arrlast[i]);
    }
    return arrfirst;
}
```

## 十三、常见的数组操作方法

- splice方法：第二位大于0便是替换，括号里面两位-删除，括号里面三位-添加-但是第二位为0.

  ```js
  //添加
  function array_middle_insert() {
      var arr = ['1','2','3','4','5','6'];
      if(0 == arr.length % 2) {   //偶数
          arr.splice(arr.length / 2,0,'中间添加');
      }
      //["1","2","3","中间添加","4","5","6"]
      console.log(JSON.stringify(arr));
  }
  //var arr = ['1','2','3','4','5','6'];arr.splice(1,2);console.log(arr);//1456  删除
  //var arr = ['1','2','3','4','5','6'];arr.splice(1,1,'5');//"1", "5", "3", "4", "5", "6"   从第一位开始除去一位 用5替换
  ```

- push() ：在数组的末尾添加一个或多个元素 返回数组新长度
- pop()：移除数组的最后一项，返回移除的项
- shift()：移除数组的第一项，返回移除项
- unshift()：在数组的第一项前面添加一个或多个元素，返回数组的长度

## 十四、js实现clone()方法

```js
var dataUtil = {
    //拷贝对象
    clone: function(myObj) {
        if (typeof (myObj) != 'object') {
            return myObj;
        }
        if (myObj == null) {
            return myObj;
        }
        if (myObj instanceof Array) {
            var myNewObj = new Array();
        } else {
            var myNewObj = new Object();
        }
        for ( var i in myObj) {
            myNewObj[i] = dataUtil.clone(myObj[i]);
        }
        return myNewObj;
    }
};
```

## 十五、导出Excel

1. 导出时，既设置`requestPara.serviceUrl`又设置`requestPara.restUrl` 

2. 有 `serviceUrl`则首先进入前端服务器后台，根据**requestPara.serviceUrl = 'report/exceldownloadtoclient';**找到对应的方法

3. **ExcelDownloadService**即为对应类，**getRestData**即为对应方法

4. getRestData方法剖析

   ```java
   public String getRestData(Map<String, Object> map){
       //追加查询条件参数，后台生成excel,需要多传2个参数：报表表头 及 报表sheetname
       //若前端已设置xlshead，则无需触发getExcelCondition进行设置
       Map<String, Object> conditionMap = map;
       if (StringUtil.isBlank(map.get("xlshead"))) {
           conditionMap = getExcelCondition(map);
       }
       //请求后台返回的报表数据
       String repid = (String) conditionMap.get("reportid");
       //使用restUrl向远程服务器获取数据，后台讲表头与数据进行拼装
       String message = defaultRestService.getRestData(conditionMap);
       if(!"2020070101".equals(repid)){
           message = message.replace("\\", "/");
       }
       Map<String,Object> mesmap = JsonUtil.jsonStrToMap(message);
       String filename = null;
       if (mesmap.get("filename") != null) {
           filename = (String) mesmap.get("filename");
       };
       //filename有的在data里面
       if (filename == null) {
           Map dataObj = (Map) mesmap.get("data");
           if (dataObj != null && dataObj.get("filename") != null) {
               filename = (String) dataObj.get("filename");
           }
       }
       map.put("restUrl", "public/common/getfile");//下载后台生成的excel文件获取均为此api
       map.put("filename", filename);
       //将后台文件下载到前台服务器
       getRestExcel(map);
       return message;
   }
   ```

   ```java
   /**
   	 * @author aming
   	 * @descripton 根据excel文件名，从后台下载文件（参数组装，及post调用）从后台把文件下载到前台服务器
   	 * @param userid
   	 * @param url
   	 * @param xlsFileName 后台生成的excel文件名称
   	 */
   public static void getRestExcel(Map<String,Object> reqMap){
       //得到传入的restUrl
       String url = (String) reqMap.get("restUrl");
       String APIstr = Const.getRestURLMap().get(url);//后台API
       String filename = (String)reqMap.get("filename");
       String userid = "GW_CPSTORE_ZG";
       UUID uuid = UUID.randomUUID();
       String uuidStr = uuid.toString();
       String uuidkey = AESUtil.encryptStr(uuid.toString(), Const.key);
       reqMap.put("uuid", uuidStr);
       reqMap.put("userid", userid);
       reqMap.put("systemid", Const.systemId);
       reqMap.put("uuidkey", uuidkey);
       reqMap.put("systemflag", "pis_preciseinvestment");
   
       //大内存后台
       String param = JsonUtil.mapToJsonStr(reqMap, 0);
       MyHttpClient client = new MyHttpClient();
       //String URL = "http://192.168.1.138:5555/";//测试环境
       //String URL = "http://192.168.1.108:3333/";//刘然内网
       //String URL = "http://192.168.1.103:3333/";//陈思敏内网
       String URL = Const.configMap.get("JZTZ_URL");
       String desPath = Const.REPORT_PATH;//excel文件下载的目标路径
       client.connectByPostForRestFile(param, URL + APIstr, desPath, filename);
   }
   ```

1. 下载文件

   ```js
   url = encodeURI("../../../pis_lcc_webcore/rest/webcore/downloadFile?filename="
                   + filename
                   + "&backname="
                   + encodeURIComponent(backname) + filetype);
   ```

   对应 **/pis_lcc_webcore/src/com/sgcc/pis/webcore/controller/DownloadFileController.java**

 ## 十六、iframe中获取当前页面对应URL

```js
function getMainFrameURL()
{
    var url = parent.document.getElementById("mainPage").contentWindow.location.href;
    alert(url);
}
```

## 十七、公共方法之Common.js

### 1. 获取当前月之前的月份数组（包括当前月）

```js
// 月份格式（用于下拉框）
var MONTH=[
		{"text" : "1月", "id" : "1"},
		{"text" : "2月", "id" : "2"},
		{"text" : "3月", "id" : "3"},
		{"text" : "4月", "id" : "4"},
		{"text" : "5月", "id" : "5"},
		{"text" : "6月", "id" : "6"},
		{"text" : "7月", "id" : "7"},
		{"text" : "8月", "id" : "8"},
		{"text" : "9月", "id" : "9"},
		{"text" : "10月", "id" : "10"},
		{"text" : "11月", "id" : "11"},
		{"text" : "12月", "id" : "12"}
	];

var PASTMONTH = [];
function getPastMonthList(){
    var currMonth = new Date().getMonth() + 1;
    for(var i = 1; i <= currMonth; i++){
        var obj = {};
        obj.text = i + "月";
        obj.id = i;
        PASTMONTH.push(obj)
    }
    return PASTMONTH;
};
```

### 2. 进度条

```js
/**
     * 进度条
     */
function showProgress(){
    //获取html的body
    var body = $('body');
    /*
    	1. 判断进度条是否存在
    	2. 给body添加进度条盒子
    	3. 设置进度条盒子 progressDiv 绝对定位，以body为准，放置中间，初值为40%
    */
    if($('#progressDiv').length ==0){
        $('<div id="progressDiv"><div id="progressNow"><span id="progressText">40%</span></div></div>').appendTo(body);
        $('#progressDiv').css({
            'position': 'absolute',
            'top': '50%',
            'left': '50%',
            'width': '500px',
            'margin-top': '-10px',
            'margin-left': '-250px',
            'background': '#e2e2e2',
            'border-radius':'20px',
            'height': '20px',
            'line-height': '20px',
            'z-Index':'999',
        });
        $('#progressNow').css({
            'width':'40%',
            'background':'#009688',
            'height':'20px',
            'line-height': '20px',
            'border-radius':'20px',
        });
        $('#progressText').css({
            'position':'static',
            'padding': '0 10px',
            'color': '#fff',
            'line-height':'20px',
            'font-size':'12px'
        })
    }
    if($('#progressShadow').length ==0){
        $('<div id="progressShadow"></div>').css({
            'z-index': '10',
            'position': 'absolute',
            'top': '0px',
            'bottom': '0px',
            'left': '0px',
            'right': '0px',
            'background':'grey',
            'opacity': '0.6'
        }).appendTo(body);
    }
    $('#progressDiv').show();
    $('#progressShadow').show();
    
    /*设置定时器 定时改变进度条进度 */
    var id = setInterval(function(){
        var value = parseInt(document.getElementById('progressText').innerHTML);
        if (value < 90) {
            value += Math.floor(Math.random()*10);
            value = value.toFixed(1)+'%';
            $('#progressNow').css('width', value);
            $('#progressText').html(value);
        }else if(value >= 100){
            $('#progressNow').css('width', '100%');
            $('#progressText').html("100%");
        }else{
            value = '99%';
            $('#progressNow').css('width', '99%');
            $('#progressText').html(value);
        }
        if ($('#progressDiv').css('display') == 'none') {
            clearInterval(id);
        }
    },1000);
}
/**
     * 关闭进度条
     */
function closeProgress(){
    $('#progressNow').css('width', '100%');
    $('#progressText').html("100%");
    setTimeout(function(){
        $('#progressDiv').hide();
        $('#progressShadow').hide();
    },50)
}
```

## 十八、数组排序（升、降）

```js
//升序
var arr3 = [30,10,111,35,1899,50,45];
arr3.sort(function(a,b){
　　return a - b;
})
console.log(arr3);//输出 [10, 30, 35, 45, 50, 111, 1899]

//降序
var arr4 = [30,10,111,35,1899,50,45];
arr4.sort(function(a,b){
　　return b - a;
})
console.log(arr4);//输出 [1899, 111, 50, 45, 35, 30, 10]

```









